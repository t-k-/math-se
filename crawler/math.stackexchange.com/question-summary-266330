\frac {\partial \mathrm{tr}(Q^TQAQ^TQA)}{\partial q_i}
Q=[q_1,...,q_N]
q_i
N
Q
N\times N
X=Q^TQA
\frac {\partial \mathrm{tr}(X^2)}{\partial q_i}
\frac {\partial \mathrm{tr}(X^2)}{\partial X} 
\frac {\partial X}{\partial q_i}
\partial_{X_{mn}} X_{ij} = \delta_{mi} \delta_{nj}
\partial_{X_{mn}} \mathop{\rm tr}X^2 =\partial_{X_{mn}} X_{ij}X_{ji} = \delta_{mi} \delta_{nj} X_{ji}+ \delta_{mj} \delta_{ni} X_{ij} = 2 X_{nm}; 
Q_{mn} = (q_n)_m
\begin{align}\partial_{(q_i)_j} X_{mn} &=\partial_{(q_i)_j} Q_{km} Q_{kl} A_{ln} =\partial_{(q_i)_j} (q_m)_k (q_l)_k A_{ln} = \delta_{im} \delta_{jk} (q_l)_k A_{ln} + \delta_{il} \delta_{jk} (q_m)_k  A_{ln}\\ &=(q_l)_j A_{ln} +(q_m)_j A_{in}\\ &= Q_{jl} A_{ln} + Q_{jm} A_{in} \end{align}
(B)_{ij}= 1
\begin{align}\partial_{(q_i)_j}  \mathop{\rm tr}(Q^TQAQ^TQA) &= \partial_{X_{mn}} \mathop{\rm tr}X^2 \partial_{(q_i)_j} X_{mn} = 2 X_{mn} [  Q_{jl} A_{ln} + Q_{jm} A_{in}]\\ &= 2  Q_{km} Q_{kl} A_{ln}^2 Q_{jl}   +  2Q_{jm} Q_{km} Q_{kl} A_{ln}  A_{in}\\ &= 2(Q Q^T Q B \mathop{\rm tr} (A A^T) +  Q Q^T Q A A^T)_{ji} \end{align}
F:M_{N\times N}(\mathbb{R})\to \mathbb{R}
F(Q)=\mathrm{tr}\Big(Q^TQAQ^TQA\Big)
\mathcal{D}F(Q_0): M_{N\times N}(\mathbb{R})\to \mathbb{R}
F
Q_0
V
[0,\ldots,q_i,\ldots,0]
 \frac{\partial}{\partial q_i}\mathrm{tr}\Big(Q^TQAQ^TQA\Big)=\mathcal{D} F(Q)\cdot[0\ldots q_i\ldots 0]. 
 [0\ldots q_i\ldots 0] = \begin{pmatrix} 0&\dots &q_{1i}&\dots & 0 \\ \vdots & \cdots & \vdots  & \cdots & \vdots \\ 0&\dots &q_{ii}&\dots &0 \\ \vdots & \cdots & \vdots  & \cdots & \vdots \\ 0&\dots &q_{Ni}&\dots &0 \\ \end{pmatrix} \mbox{ and }  q_i= \begin{pmatrix} q_{1i} \\ \vdots \\ q_{ii} \\ \vdots \\ q_{Ni} \end{pmatrix} 
 F(Q_0+V)=F(Q_0)+\mathcal{D}F(Q_0)\cdot V+ \|V\|\cdot\rho(V),\quad \lim_{V\to 0}\frac{\rho(V)}{\|V\|}=0\quad \mbox{ and }\|V\|=\sqrt{tr(V^TV)} 
